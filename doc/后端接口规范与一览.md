项目由互相分离的前端和后端构成。前端采用HTML5 History API实现的前端路由，单页面应用形式。后端除500以外，以json格式的数据响应请求，不返回任何HTML页面。在默认的开发配置下，后端在`localhost:8000`启动测试服务器，可以访问`localhost:8000/admin`对数据库进行直接控制。前端的单个页面会在运行`npm run build`后出现在`client/dist/index.html`，也可以使用vue提供的开发服务器，默认启动在`localhost:8080`，提供热更新。

由于前端和后端不会由同一个服务器进程进行分发，因此前端与后端的各URI可以重复。本文档只涉及后端接口的命名和规范。

----

所有后端API均采用GET或POST方法。POST方法携带的body为json字典的数据格式。GET方法携带的query参数为`data=<quoted json data>`形式，同样使用json字典来编码实际载荷。这样做可以更方便的传递数值或者布尔值类型的参数，省去解析字符串所带来的额外逻辑和错误处理。这样做的主要弊端是限制了GET接口所能接受的参数长度。

后端返回的结果，只有200和500两种状态码。后端不会主动生成500状态的返回，因此所有500状态的返回都代表后端bug。所有200状态的返回内容格式均为一个json字典，并具有`success`和`message`两个字段。`success`字段的值为布尔类型，代表着后端收到的请求是否合法。注意：`success`为`false`的返回的含义是「你对这个接口的使用方式是错误的」，如果这个接口被设计为有时会失败，那么失败时也应该返回`success`为`true`的结果。任何`success`为`false`的返回都代表前端bug。`message`是一个对于错误的简要描述字符串，当`success`为`true`时总是`"ok"`。这个字符串是给开发者而不是用户看的，永远不要把它显示在UI上。

当`success`为`true`的时候，返回的结果中可能会带有一个`data`字段，其中包含该接口提供的信息。若`success`为`false`则绝不会出现`data`字段。

`client/src/api.js`对后端API的使用进行了封装，使用方式如下：

```js
import api from './api'  // 使用API的代码文件与api.js的相对路径

api.get('angel/info').then(data => {
    // 若返回的`success`为`true`，这里可以通过`data`变量访问
    // 返回结果中的`data`字段
})

// 不需要额外参数的POST接口
api.post('angel/logout').then(() => {
    // 只有写在这里的代码才能确保会在用户正常注销以后被执行
})
// 这里的代码会在请求发出以后立即被执行，哪怕返回`success`为`false`的结果也拦不住

// 携带额外参数的POST接口，GET接口与此类似
api.post('angel/update', {nickname: 'cowsay'}).then(() => {
    // 这个接口返回的结果中没有`data`字段，因此回调函数不需要`data`参数
})
```

目前的封装没有对出错的情况（无论是500还是`success`为`false`）进行有效地处理，以后需要针对此对`api.js`进行更新。

----

以下数据格式为各API通用格式。在API中以「xx对象」进行引用。

用户（Angel）对象
* `id`
* `registered_name`真实姓名
* `registered_id`学号
* `nickname`昵称
* `phone`联系电话
* `avatar`头像资源的URL
* `group`加入的组织（组织，没有`angels`）
* `contribution`累积捐助
* `honors`勋章列表

组织（Group）对象
* `id`
* `name`名称
* `avatar`头像
* `description`简介
* `angels`成员（用户）列表
* `leader`负责人（用户）
* `honors`勋章列表

勋章（Honor）对象
* `id`
* `description`
* `logo`

任务（Task）对象
* `id`
* `description`
* `sourceGeometry`（可选）出发地的地理位置，地理位置的具体表示在接入第三方服务后再明确
* `destinationGeometry`（可选）
* `cost`
* `owner`发起者（用户）
* `create_at`发起时间
* `helper`（可选）完成者（用户）
* `accept_at`（可选）接受时间
* `complete_at`（可选）完成时间
* `finish_at`（可选）结束时间
* `contribution`（可选）捐赠金额
* `status`当前状态。其值为以下之一：
    * `"created"`等待接受
    * `"accepted"`已被接受
    * `"completed"`创建者已确认完成
    * `"finished"`接受者已将任务金额处置完毕

项目（Project）对象
* `id`
* `description`
* `news_list`相关新闻（新闻，没有`content`）列表
* `cost`资金需求
* `raised`已筹集资金
* `finished`是否已经结束，布尔值
* `contributor_groups`捐助该项目的组织（组织，没有`angels`）列表
* `contributor_angels`捐助该项目的用户（用户）列表
* `create_at`立项时间
* `finish_at`完成时间

新闻（News）对象
* `id`
* `title`标题
* `date`发布时间
* `preview`（可选）缩略图
* `author`发布者
* `content`内容，可能包含HTML元素

----

用户登录以后，客户端可以索取以上对象信息，以用户对象为例：

```
GET /angel
```

这个接口需要一个参数`id_list`，值为一个列表，为所要获取信息的各对象的ID。返回的结果为一个列表，其中的每一项为一个对象内容的字典。

项目和新闻对象还具有以下接口

```
GET /project/list
```

获取所有项目和新闻的ID和基本信息。返回一列项目（不含`news_list``contributor_angels`和`contributor_groups`）或新闻（不含`content`）对象。

若客户端用户没有登录，这些接口返回错误信息`not logged in`。

----

```
GET /task/related
```

返回与当前登录用户有关的任务ID。返回值为一个列表，包含每一个任务的ID。可以传入一个参数`finished`，并将其值设置为`false`，可以避免将状态为`finished`的任务包含在返回列表中。

```
GET /task/available
```

返回当前用户可以接受的任务ID列表。返回值为一个包含任务ID的列表。可以传入`sourceGeometry`和`destinationGeometry`参数指定用户预期的出发地和目的地。对于同一个用户，默认每一个获取该列表都不会包含重复的任务，可以传入`reset`并将其值设置为`true`使服务端「遗忘」已经发送的任务。

```
POST /task
```

创建一个新任务。需要传入`description``sourceGeometry``desctinationGeometry`和`payment`四个参数。其中`payment`为客户端支付完成后从支付服务获取的凭证。服务端将使用这一凭证确认支付金额。创建成功的返回值为创建的任务对象。

```
POST /task/accept/<task ID>
```

```
POST /task/complete/<task ID>
```

```
POST /task/finish/<task ID>
```

将一个任务的状态更新。其中`finish`接口需要传入一个参数`contribution`，值为捐赠的金额。每一个接口成功的返回值为该任务对象。

----

```
GET /angel/login
```

确认客户端是否已经登录。需要传入一个参数`back`，内容为一个网址路径（不需要域名主机部分）。接口返回一个字典，其中`logged_in`字段的值指示客户端是否已经登录。如果其值为`true`，则`angel`字段为登录账户的用户对象；如果其值为`false`，则`redirect`字段的值为一个网址。客户端访问该网址，展示给应用用户，用户在此页面上完成登陆后，会跳转回`back`指定的网址（域名与访问该接口时一致），并携带合适的票据信息，具体由登录服务决定。

```
POST /angel/login
```

使客户端登录。如果已经登录则覆盖当前的登录信息。提交的参数`ticket`的值为登录服务提供的票据信息。若登陆成功，返回值为当前登录的用户对象。

```
POST /angel/logout
```

注销当前登录的用户。

```
POST /angel/edit
```

更改当前登录的用户信息，可以传入`nickname``phone``group_id`和`avatar`（以file域传入）。

```
POST /group/<group ID>/edit
```

更改当前登录用户所管理的组织的信息，可以传入`name``description``deleted_angel_list`和`avatar`。其中`deleted_angel_list`为被删除的组织内成员的用户ID。

----

```
GET /board/<board name>
```

返回排行榜信息。`<board name>`为排行榜名字。暂时定为：
* `angeldaily` 每日个人排行
* `groupweekly` 每周组织排行

返回值为一个字典，字段`update_at`的值为排行榜更新的时间，`title`为排行榜标题，`item_type`的值为`"angel"`或`"group"`指示`items`中的对象类型，`items`为一个列表，顺次排列上榜的用户或组织（没有`angels`）。
