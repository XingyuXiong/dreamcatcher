项目由互相分离的前端和后端构成。前端采用HTML5 History API实现的前端路由，单页面应用形式。后端除500以外，以json格式的数据响应请求，不返回任何HTML页面。在默认的开发配置下，后端在`localhost:8000`启动测试服务器，可以访问`localhost:8000/admin`对数据库进行直接控制。前端的单个页面会在运行`npm run build`后出现在`client/dist/index.html`，也可以使用vue提供的开发服务器，默认启动在`localhost:8080`，提供热更新。

由于前端和后端不会由同一个服务器进程进行分发，因此前端与后端的各URI可以重复。本文档只涉及后端接口的命名和规范。

----

根据应用功能的划分，后端API分为三组，分别位于`angel/`（账号模块），`task/`（接单模块），`news/`（新闻模块）下。聊天模块很可能使用第三方服务接入的方式实现，暂时不涉及。

所有后端API均采用GET或POST方法。POST方法携带的body为json字典的数据格式。GET方法携带的query参数为`data=<quoted json data>`形式，同样使用json字典来编码实际载荷。这样做可以更方便的传递数值或者布尔值类型的参数，省去解析字符串所带来的额外逻辑和错误处理。这样做的主要弊端是限制了GET接口所能接受的参数长度。

后端返回的结果，只有200和500两种状态码。后端不会主动生成500状态的返回，因此所有500状态的返回都代表后端bug。所有200状态的返回内容格式均为一个json字典，并具有`success`和`message`两个字段。`success`字段的值为布尔类型，代表着后端收到的请求是否合法。注意：`success`为`false`的返回的含义是「你对这个接口的使用方式是错误的」，如果这个接口被设计为有时会失败，那么失败时也应该返回`success`为`true`的结果。任何`success`为`false`的返回都代表前端bug。`message`是一个对于错误的简要描述字符串，当`success`为`true`时总是`"ok"`。这个字符串是给开发者而不是用户看的，永远不要把它显示在UI上。

当`success`为`true`的时候，返回的结果中可能会带有一个`data`字段，其中包含该接口提供的信息。若`success`为`false`则绝不会出现`data`字段。

`client/src/api.js`对后端API的使用进行了封装，使用方式如下：

```js
import api from './api'  // 使用API的代码文件与api.js的相对路径

api.get('angel/info').then(data => {
    // 若返回的`success`为`true`，这里可以通过`data`变量访问
    // 返回结果中的`data`字段
})

// 不需要额外参数的POST接口
api.post('angel/logout').then(() => {
    // 只有写在这里的代码才能确保会在用户正常注销以后被执行
})
// 这里的代码会在请求发出以后立即被执行，哪怕返回`success`为`false`的结果也拦不住

// 携带额外参数的POST接口，GET接口与此类似
api.post('angel/update', {nickname: 'cowsay'}).then(() => {
    // 这个接口返回的结果中没有`data`字段，因此回调函数不需要`data`参数
})
```

目前的封装没有对出错的情况（无论是500还是`success`为`false`）进行有效地处理，以后需要针对此对`api.js`进行更新。

----

```
GET angel/info
```

获取当前登录状态和基本信息。

返回值（在没有500和`success`为`false`的情况下，下略）为一个字典。`login_required`字段为布尔值，若用户已经登录则为`false`。当`login_required`为`false`时有`angel`字段，其值为一个字典，内容为当前登录用户的信息，包含：
* `id`
* `registered_name`真实姓名
* `registered_id`学号
* `nickname`昵称
* `contribution`累计捐赠金额
* `phone`手机号
* `sex`性别

```
POST angel/login
```

登录账号。如果已经登录则登录信息将被替换。

接受两个参数`back`和`ticket`。这个接口通常与OAuth配合使用，登录过程中需要调用两次。第一次，仅以`back`参数进行调用，返回结果中含有`ticket_required`和`redirect_url`两个字段，`ticket_required`的值为`true`，`redirect_url`的值为一个网址链接。客户端访问该网址，用户在该外部页面上填写身份信息，验证通过后，将会跳转回`back`参数所指定的URL，并带有`ticket`参数。第二次调用，以`back`和`ticket`参数进行调用，返回结果中含有`ticket_required`，`exist`和`angel`三个字段，并且`ticket_required`的值为`false`。

若该用户之前已经在本应用中登陆过，则`exist`的值为`true`，`angel`与`GET angel/info`接口中一致。若用户第一次登陆本应用，则对本接口的第二次调用将自动为她创建一个本应用的账号，返回`exist`的值为`false`，`angel`当中只包含`registered_name`，`registered_id`，`sex`和`phone`四个字段。前端应引导用户进行初始信息填写，并使用`angel/update`进行更新。

----

以下所有接口均需要在用户已经登录的前提下调用，即`GET angel/info`返回的`login_required`字段为`false`。否则将返回

```json
{
    "success": false,
    "message": "not log in"
}
```

```
POST angel/update
```

修改当前登录用户的账号信息，可以提交的参数与上述接口对`angel`字段的描述一致，但`registered_*`和`contribution`不可更改。

```
POST angel/logout
```

注销当前登录用户。

```
GET angel/<int: angel ID>
```

获取其它用户的信息。返回值内容与`GET angel/info`的`angel`字段内容一致。

```
GET task
```

获取与当前用户有关的任务信息。返回结果包括`owned`，`accepted`两个字段，分别为该用户创建的任务和接受的任务。两者的值均为装有任务的列表。无论任务是否完成都会被返回。

每一个任务为一个字典，其中包括以下字段：

* `description`任务描述
* `fromGeometry`出发地点
* `toGeometry`到达地点
* `owner`创建者ID
* `acceptor`完成者ID
* `cost`创建者支付的金额
* `contribution`完成者捐出的金额
* `accepted`是否已经有人接受该任务，如果还没有被接受则相关字段为`null`
* `finished`是否已经被完成，如果还没有则相关字段为`null`
* `ended`完成者是否已经捐赠或获得金额，同上
* `canceled`创建者是否已经取消了任务，同上
* `createdAt`创建任务的时间
* `acceptedAt`接受任务的时间
* `finishedAt`完成任务的时间
* `endedAt`结束任务的时间
* `canceledAt`任务取消的时间

地点的具体表示方式等地理位置API接入以后再详细定义。

```
GET task/available
```

获取用户可以接受的任务列表。接受三个参数`reset`，`fromGeometry`和`toGeomoery`。默认同一任务不会出现在对该接口的多次调用中，如果传入`reset`为`true`则强制「遗忘」已经发送给用户的任务。用户可以通过`fromGeometry`和`toGeometry`指定自己希望的任务起止地点。

返回结果为一个列表，其中的每一项与`GET task`中的描述一致。

```
POST task/new
```

创建一个新任务，需要包含`description`，`fromGeometry`，`toGeometry`和`cost`参数，各参数描述以及该接口返回结果与`GET task`中对任务的描述一致。

```
POST task/<int: task ID>/accept
```

接受一个任务。返回结果包含一个字段`accepted`，若为`true`则成功接受了该任务，否则任务已经被其他人接受了。

```
POST task/<int: task ID>/finish
```

确认一个任务已经被完成。

```
POST task/<int: task ID>/end
```

结束一个任务。接受一个参数`contribution`表示完成者捐赠的金额。剩余部分的金额将打给完成者的账号。

```
POST task/<int: task ID>/cancel
```

取消一个任务。

```
GET news
```

获取新闻列表。接受两个参数，`count`表示所需新闻条数，`before`为一个时间。将返回比`before`更早的要求条数的新闻，按照由新到旧排列。

返回值为一个列表，其中的每一项为一个字典包含：

* `id`
* `title`新闻标题
* `time`时间
* `excerpt`摘要

```
GET news/<int: news ID>
```

获取一条新闻的内容。返回值与`GET news`当中对新闻的描述相同，同时添加一个`detail`字段，包含新闻的详细内容。可以包含HTML元素。


```
GET news/boards
```

返回各排行榜。返回值为一个列表，其中每个字典包含`name`和`list`两个字段。`list`的值是一个列表，其中的每一项和`GET angel/info`中`angel`字段的描述一致。
